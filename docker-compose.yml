services:
  backend:
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
    container_name: graph_duty_b24_backend
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - ./backend/data:/app/data
      - ./backend:/app
    environment:
      - BITRIX24_WEBHOOK=${BITRIX24_WEBHOOK:-}
      - BITRIX24_ACCESS_TOKEN=${BITRIX24_ACCESS_TOKEN:-}
      - APP_NAME=${APP_NAME:-Graph Duty B24}
      - DEBUG=${DEBUG:-False}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./data/graph_duty.db}
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-True}
      - DEFAULT_UPDATE_TIME=${DEFAULT_UPDATE_TIME:-09:00}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:80,http://localhost}
    restart: unless-stopped
    networks:
      - graph_duty_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: ./frontend
      dockerfile: docker/Dockerfile
    container_name: graph_duty_b24_frontend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - graph_duty_network

networks:
  graph_duty_network:
    driver: bridge
